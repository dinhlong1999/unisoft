<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.springmvc.repository.ProductMapper">
    <select id="getListProduct" resultType="java.util.Map">
        <![CDATA[
        SELECT
            id, codeProduct, flag, inventory, nameProduct, priceBuy, priceSell
        FROM
            product
        WHERE
       		flag = 0
        AND
            (CASE WHEN #{arg0} IS NOT NULL OR #{arg0} != ''
            THEN  codeProduct LIKE concat('%', #{arg0},'%')
            ELSE 1=1 END)
        AND
            ( CASE WHEN #{arg1} IS NOT NULL OR #{arg1 } != ''
            THEN  nameProduct LIKE concat('%', #{arg1},'%')
            ELSE 1=1 END)

        ORDER BY
            nameProduct
        LIMIT
            #{arg2} OFFSET #{arg3}
        ]]>
    </select>

    <select id="totalCountGetListProduct" resultType="int">
        <![CDATA[
            SELECT
                count(*)
            FROM
                product
            WHERE
        	  flag = 0
            
            AND
               (CASE WHEN #{arg0} IS NOT NULL OR #{arg0} != ''
            		THEN  codeProduct LIKE concat('%', #{arg0},'%')
            		ELSE 1=1 
            	END)
        	AND
               (CASE WHEN #{arg1} IS NOT NULL OR #{arg1 } != ''
            		THEN  nameProduct LIKE concat('%', #{arg1},'%')
            		ELSE 1=1 
            	END)	
        ]]>
    </select>
    
    <insert id="insertProduct" parameterType="com.example.springmvc.model.Product" useGeneratedKeys="true" keyProperty="id">
    	<![CDATA[
    		INSERT INTO product(codeProduct,nameProduct,inventory,priceBuy,priceSell)
    		VALUES(
    			#{codeProduct},
    			#{nameProduct},
    			#{inventory},
    			#{priceBuy},
    			#{priceSell}
    			);
    	]]>
    	
    </insert>
    
    
  	 <select id="getNameProductExists" resultType="int" >
   		SELECT 
   			count(*) 
   		FROM 
   			product 
   		WHERE 
   			nameProduct = #{nameProduct}
     </select>
     
     <select id="getCodeProductExists" resultType ="int">
     	SELECT 
     		count(*) 
     	FROM 
     		product 
     	WHERE 
     		codeProduct = #{codeProduct}
     </select>
     
     <select id="getNameProductExistsToUpdate" resultType="int">
     	<![CDATA[
     		SELECT 
   				count(*) 
   			FROM 
   				product 
   			WHERE 
   				nameProduct = #{arg0}
			AND
			id <> #{arg1};
     	]]>
     </select>
     <select id="getCodeProductExistsToUpdate" resultType="int">
     	<![CDATA[
     		SELECT 
   				count(*) 
   			FROM 
   				product 
   			WHERE 
   				codeProduct = #{arg0}
			AND
			id <> #{arg1};
     	]]>
     </select>
    
    <update id="deleteProduct"  parameterType="int">
    	<![CDATA[
    		UPDATE 
    			product 
    		SET 
    			flag = 1 
    		WHERE 
    			id = #{id};
    	]]>
    </update>
    
    <select id="getDeleteProductCount" parameterType="int" resultType="int">
    	<![CDATA[
       		SELECT 
       			count(*) 
       		FROM 
       			product 
       		WHERE 
       			id = #{id} 
       		AND 
       			flag = 1;
    	]]>
    </select>
    
    <select id="getProductById" resultType="com.example.springmvc.model.Product">
    	<![CDATA[
    		SELECT 
    			id,nameProduct,codeProduct,priceSell,priceBuy,inventory,version
    		FROM 
    			product 
    		WHERE 
    			id = #{id};
    	]]>
    </select>
    
    <update id="updateProduct" >
    	<![CDATA[
    		UPDATE
    			product
    		SET
    			nameProduct = #{nameProduct},
    			codeProduct = #{codeProduct},
    			priceSell   = #{priceSell},
    			priceBuy    = #{priceBuy},
    			version     = (#{version} + 1 )
    		WHERE
    			id          = #{id}
    		AND
    			version     = #{version}
    	]]>
    </update>
    
    <select id="getCodeProductByNameProduct" resultType="String">
    	<![CDATA[
    		SELECT
    			codeProduct
    		FROM
    			product
    		WHERE
    			nameProduct = #{nameProduct}
    	]]>
    </select>
    
    <select id="getNameProductByCodeProduct" resultType="String">
    	<![CDATA[
    		SELECT 
    			nameProduct
    		FROM
    			product
    		WHERE
    			codeProduct = #{codeProduct}
    	]]>
    </select>

</mapper>