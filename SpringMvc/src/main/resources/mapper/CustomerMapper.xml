<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.springmvc.repository.CustomerMapper" >

	<select id="getListCustomer" resultType="java.util.Map">
	   SELECT
			c.customer_id AS id, 
			c.name,
			c.phone,
			c.address,
			c.version,
			e.name AS employeeName,
			e.employee_id AS employeeId,
			e.account_id AS accountId
		FROM 
			customers c
		JOIN
			employees e on c.employee_id = e.employee_id
		WHERE 
	 		c.flag = 0
	 	<if test="arg0 != null || arg0 == ''">
	 	     AND c.name LIKE CONCAT ('%',#{arg0},'%')
	 	</if>
	 	<if test="arg1 != null || arg1 == ''">
	 	     AND c.phone LIKE CONCAT (#{arg1},'%')
	 	</if>
	 	ORDER BY
	 		c.name
	 	LIMIT
	 		#{arg2} OFFSET #{arg3}
	 
	</select>
	
	<select id="countRecordOfCustomer" resultType="int">
		
			SELECT
				count(*)
			FROM 
				customers c
			JOIN
				employees e on c.employee_id = e.employee_id
			WHERE 
	 			c.flag = 0
	 		<if test="arg0 != null || arg0 == ''">
                AND c.name LIKE CONCAT ('%',#{arg0},'%')
            </if>
            <if test="arg1 != null || arg1 == ''">
                AND c.phone LIKE CONCAT (#{arg1},'%')
            </if>
		
	</select>
	
	<update id="deleteCustomer">
		<![CDATA[
			UPDATE 
				customers
			SET
				flag = 1,
				version = version + 1
			WHERE
				customer_id = #{arg0}
			AND
			    version = #{arg1}
			
		]]>
	</update>

	<update id="editCustomer">
		<![CDATA[
			UPDATE
				customers
			SET
			    name = #{arg0},
			    address = #{arg1},
			    version = version + 1,
			    phone = #{arg3}
			WHERE
			    customer_id = #{arg4}
			AND
			    version = #{arg2}
		]]>
	</update>

	<select id="getCustomerById" resultType="java.util.Map">
		<![CDATA[
			SELECT
			    c.customer_id as id,
			    c.name,
			    c.phone ,
			    c.version,
			    c.address,
			    e.name AS employeeName,
			    e.employee_id AS employeeId
			FROM
			    customers c
			JOIN
				employees e on e.employee_id = c.employee_id
			WHERE
			    c.customer_id = #{customerId}
		]]>
	</select>

	<select id="checkPhoneNumberExists" resultType="int">
		
			SELECT
			    count(*)
			FROM
			    customers
			WHERE
			    phone = #{arg0}
			<if test="arg1 != null || arg1 != 0">
			     AND customer_id != #{arg1}			  
			</if>
			
		
	</select>



	<insert id="saveCustomer">
		<![CDATA[
			INSERT INTO
				customers(name, address,phone, employee_id)
			VALUES (
			    #{arg0}, #{arg1}, #{arg2},#{arg3}
				   )

		]]>
	</insert>

	<select id="getPhoneNumberByNameCustomer" resultType="String">
		<![CDATA[
			SELECT
			    phone 
			FROM
			    customers
			WHERE
			    name = #{customerName}
		]]>
	</select>

	<select id="getNameByPhoneNumberCustomer" resultType="String">
		<![CDATA[
		  SELECT
			name
		  FROM
			customers
		  WHERE
			phone = #{customerPhone}
		]]>
	</select>

	<select id="getIdCustomerByPhoneNumber" resultType="int">
		<![CDATA[
			SELECT
			    customer_id
			FROM
			    customers
			WHERE
			    phone = #{customerPhone}
			AND
			    flag = 0;
		]]>
	</select>

</mapper>