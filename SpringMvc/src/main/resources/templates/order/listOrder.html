<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Quản lý đơn hàng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
          <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        h1,td,th {
            text-align: center;
        }
        input{
            border-radius: 5px;
        }
        table{
            background-color: white;
        }
        body {
            background-color: #EAE9E5;
        }
        .createform {
            margin-bottom:5px;
        }
        .createform button {
            background-color:white;
            border-radius:5px;
        }
        #btn{
            margin-left: auto;
        }
    </style>
</head>
<body>


    <div th:insert = "header :: nav"></div>
    
    <div class="container-fluid">
        <h1>Danh sách đơn hàng</h1>
        
        <div style="color: red" th:if="${message}">
        <span  th:text="${message}"></span>
        <script th:inline="javascript">           
            function myJavaScriptFunction() {
                var message = /*[[${message}]]*/ '';
                alert(message);
                
            }
                myJavaScriptFunction();
           

        </script>
    </div>
   
   <div class="form-search">
        <form th:action="@{/orders/list}" method="get" >
            <div th:if = "${roleName == 'ROLE_ADMIN'}">
            	<span>
                	Tên đăng nhập : <input type="text"  name="username" style="width:15%;margin-left: 11px" th:value="${username}" placeholder="Vui lòng nhập tên đăng nhập">
            	</span>
            </div>
            <div style="margin-top: 5px" th:if = "${roleName == 'ROLE_ADMIN'}">
            	<span>
                	Tên nhân viên : <input type="text"  name="employeeName" style="width:15%;margin-left: 18px" th:value="${employeeName}" placeholder="Vui lòng nhập tên nhân viên">
            	</span>
            </div>
             <div style="margin-top: 5px">
            	<span>
                	Mã sản phẩm  : <input type="text"  name="codeProduct" style="width:15%;margin-left: 19px" th:value="${codeProduct}" placeholder="Vui lòng nhập mã sản phẩm">
            	</span>
             </div>
            <div style="margin-top: 5px">
            	<span>
                	Tên sản phẩm  : <input type="text"  name="nameProduct" style="width:15%;margin-left: 18px" th:value="${nameProduct}" placeholder="Vui lòng nhập tên sản phẩm">
            	</span>
            </div>
            <div style="margin-top: 5px">
            	<span>
                	Tên khách hàng  : <input type="text"  name="customerName" style="width:15%;margin-left: 5px" th:value="${customerName}" placeholder="Vui lòng nhập tên khách hàng">
            	</span>
            </div>
            <div style="margin-top: 5px">
            	<span>
                	Số điện thoại : <input type="text"  name="phoneNumber" style="width:15%;margin-left: 13px" th:value="${phoneNumber}" placeholder="Vui lòng nhập số điện thoại">
            	</span>
            </div>
             <div style="margin-top: 5px">
            	<span>
                	Ngày bắt đầu  : <input type="date"  name="dateStart" style="width:8%;margin-left: 2px" th:value="${dateStart}">
            	</span>
            </div>
            <div style="margin-top: 5px">
            	<span>
                	Ngày kết thúc  : <input type="date"  name="dateEnd" style="width:8%;margin-left: 7px" th:value="${dateEnd}">
            	</span>
            </div>
           <div style="margin-top: 5px">
           			Trạng thái
            	<span style="margin-left: 3%">
                	 <input type="checkbox" name ="statusAllocation" th:checked = "${statusAllocation == 2 ? 'checked' : null}" value="2"  > Đã Phân bổ
            	</span>
            	<span style="padding-left: 3%">
                	 <input type="checkbox" name ="statusBooking" value="1" th:checked = "${statusBooking == 1 ? 'checked' : null}"> Đã đặt hàng
            	</span>
            </div>
            <div style="margin-top: 5px;">
                <input style="margin-bottom: 5px" type="submit" value="Search">
                <input style="margin-bottom: 5px" type="reset" value="Clear" >
            </div>
        </form>
      </div> 
      
      
      <div>
      	<table id="myTable" class="table table-hover table-bordered">
      		<tr style="background-color: grey;color: white">
   	     			<th>STT</th>
   	     			<th>NGÀY ĐẶT HÀNG</th>
   	     			<th>Mã sản phẩm</th>
   	     			<th>TÊN SẢN PHẨM</th>
   	     			<th>GIÁ BÁN</th>
   	     			<th>SỐ LƯỢNG</th>
   	     			<th>TÊN KHÁCH HÀNG</th>
   	     			<th>SỐ ĐIỆN THOẠI</th>
   	     			<th>ĐỊA CHỈ</th>
   	     			<th>TRẠNG THÁI</th>
   	     			<th>NGÀY PHÂN BỔ</th>
   	     			<th th:if = "${roleName == 'ROLE_ADMIN'}">TÊN ĐĂNG NHẬP</th>
   	     			<th th:if = "${roleName == 'ROLE_ADMIN'}">TÊN NHÂN VIÊN </th>
   	     	</tr>
   	     	<tr th:if="${ordersMap.size() > 0}" th:each="order,status:${ordersMap}" th:id="${order['id']}">
                <td th:text="${status.count + page * limit}"></td>
                <td th:text="${#temporals.format(order['dateStart'], 'yyyy/MM/dd HH:mm:ss')}"></td>
                <td class="codeProduct" contenteditable="true"  th:text="${order['codeProduct']}" ></td>
                <td class="nameProduct" contenteditable="true" th:text="${order['nameProduct']}"></td>
                <td th:text="${#numbers.formatDecimal(order['price'], 0, 'COMMA', 0, 'POINT')} + ' VND'"></td>
                <td class="quantityBook"contenteditable="true" th:text="${order['quantityBook']}" ></td>
                <td class="customerName" contenteditable="true" th:text="${order['customerName']}"></td>
                <td class="phoneNumber" contenteditable="true" th:text="${order['phoneNumber']}" ></td>
                <td th:text="${order['address']}"></td>
                <td th:text="${order['statusName']}"></td>
                <td th:text="${order['dateAllocation'] != null ? #temporals.format(order['dateAllocation'], 'yyyy/MM/dd HH:mm:ss') : 'Chưa phân bổ' }"></td>
                <td th:if = "${roleName == 'ROLE_ADMIN'}" th:text="${order['username']}"></td>
                <td th:if = "${roleName == 'ROLE_ADMIN'}" th:text="${order['employeeName']}"></td>
   	     	</tr>
            <tr th:if="${ordersMap.size() == 0}">
                <td colspan="13">Không tìm thấy đơn hàng</td>
            </tr>
      	</table>
      	<button id= "addRow" style="border-radius: 5px">Thêm dòng mới</button>
      	 <div th:if="${ordersMap.size() > 0}">
            <nav aria-label="Page navigation example" > 
	            <ul class="pagination" style="display: flex;justify-content: center">
	            	<li th:if="${page > 0}" class="page-item" >
	            		<a class="page-link" th:href="@{/orders/list(page=${page},username=${username},employeeName=${employeeName},codeProduct=${codeProduct},nameProduct=${nameProduct},customerName=${customerName},phoneNumber=${phoneNumber},dateStart=${dateStart},dateEnd=${dateEnd},statusAllocation=${statusAllocation},statusBooking=${statusBooking})}">Previous</a>
	            	</li>
	            	<li class="page-item"  th:if="${showStartEllipsis}">
	            		<span class="page-link">...</span >
	            	</li>
	            	<th:block th:each="pageNumber : ${#numbers.sequence(startPage, endPage)}">
	            		<li class="page-item active" th:if="${pageNumber -1 == page}">
	            			 <a class="page-link "  th:text="${pageNumber}"></a>	          
	            		</li>
	            		<li class="page-item" th:if="${pageNumber -1 != page}">
	            			<a class="page-link" th:text="${pageNumber}"  th:href="@{/orders/list(page=${pageNumber},username=${username},employeeName=${employeeName},codeProduct=${codeProduct},nameProduct=${nameProduct},customerName=${customerName},phoneNumber=${phoneNumber},dateStart=${dateStart},dateEnd=${dateEnd},statusAllocation=${statusAllocation},statusBooking=${statusBooking})}" ></a>
	            		</li>
	            	</th:block>
	            	<li class="page-item"  th:if="${showEndEllipsis}">
	            		<span  class="page-link">...</span>
	            	</li>
	            	<li class="page-item" th:if="${page + 1 != totalPage }">
	            		<a class="page-link" th:href="@{/orders/list(page=${page + 2},username=${username},employeeName=${employeeName},codeProduct=${codeProduct},nameProduct=${nameProduct},customerName=${customerName},phoneNumber=${phoneNumber},dateStart=${dateStart},dateEnd=${dateEnd},statusAllocation=${statusAllocation},statusBooking=${statusBooking})}">Next</a>
	            	</li>
	            </ul>
            </nav> 
        </div>
        
        <div style="float:right">
        	<button style="border-radius: 5px" id= "save">Lưu </button>
        	<button style="border-radius: 5px" id= "reset" onclick="reset()">Reset</button>
        </div>
      </div>
    </div>
</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous">
</script>
<script>
        $('#addRow').on('click',function () {
        	  let newRowID = taoIDMoi();
            $('#myTable').append('<tr class="newRow" id='+newRowID + ' >' +
                '                     <td></td>\n' +
                '                     <td></td>\n' +
                '                     <td class="codeProduct" contenteditable="true" ></td>\n' +
                '                     <td class="nameProduct" contenteditable="true"></td>\n' +
                '                     <td></td>\n' +
                '                     <td class ="quantityBook" contenteditable="true"></td>\n' +
                '                     <td class="customerName" contenteditable="true"></td>\n' +
                '                     <td class="phoneNumber" contenteditable="true"></td>\n' +
                '                     <td ></td>\n' +
                '                     <td></td>\n' +
                '                     <td></td>\n' +
                '                     <td th:if = "${roleName == \'ROLE_ADMIN\'}"></td>\n' +
                '                     <td th:if = "${roleName == \'ROLE_ADMIN\'}"></td>' +
                '                </tr>')

        });

        $('#myTable').on('focusout','td.codeProduct[contenteditable="true"]',function () {
        	   let codeProduct = $(this).text();
               let row = $(this).closest("tr");
               let nameProductCell = row.find("td:eq(3)");
               let valueCodeProduct = $(this);
               let table = document.getElementById("myTable");
               let lastRow = table.rows[table.rows.length - 1];
               console.log(lastRow)
               console.log(table.rows.length)
               $.ajax({
                   contentType :"application/json",
                   method : "GET",
                   url : `http://localhost:8081/api/product/getNameProduct?codeProduct=`+encodeURIComponent(codeProduct),
                   success : function(data) {
                       if (data === "") {
                           nameProductCell.text('')
                           valueCodeProduct.text('')
                       }
                       else {
                           nameProductCell.text(data)
                       }
                   },
                   error:function(xhr, textStatus, errorThrow){
                       console.log("Error",errorThrow)
                   }
               })
        })
        
         $('#myTable').on('focusout','td.nameProduct[contenteditable="true"]',function () {
        	  let nameProduct = $(this).text();
              let row = $(this).closest("tr");
              let codeProductCell = row.find("td:eq(2)");
              let valueNameProduct = $(this);

              $.ajax({
                  contentType :"application/json",
                  method : "GET",
                  url : `http://localhost:8081/api/product/getCodeProduct?nameProduct=`+encodeURIComponent(nameProduct),
                  success : function(data) {
                      if (data === "") {
                          codeProductCell.text('')
                          valueNameProduct.text('')
                      }
                      else {
                          codeProductCell.text(data)
                      }
                  },
                  error:function(xhr, textStatus, errorThrow){
                      console.log("Error",errorThrow)
                  }
              })
        })
        
         $('#myTable').on('focusout','td.customerName[contenteditable="true"]',function () {
        	 // Thực hiện yêu cầu Ajax khi ô customerName mất focus
             let customerName = $(this).text();
             let row = $(this).closest("tr");
             let phoneNumberCell = row.find("td:eq(7)");
             let valueCurrentCustomerName = $(this);
             $.ajax({
                 contentType :"application/json",
                 method : "GET",
                 url: `http://localhost:8081/api/customer/getPhoneNumber?customerName=`+encodeURIComponent(customerName),
                 success:function (data) {
                     if (data === ""){
                         valueCurrentCustomerName.text('')
                         phoneNumberCell.text('');
                     }else {
                         phoneNumberCell.text(data);
                     }
                 },
                 error:function (xhr,textStatus,errorThrow) {
                     console.log("Error",errorThrow)
                 }

             })
        })
        
        $('#myTable').on('focusout','td.phoneNumber[contenteditable="true"]',function () {
                // Thực hiện yêu cầu Ajax khi ô phoneNumber mất focus
                let phoneNumber = $(this).text();
                let row = $(this).closest("tr");
                let customerName = row.find("td:eq(6)");
                let valueCurrentPhoneNumber = $(this);
                $.ajax({
                    contentType :"application/json",
                    method : "GET",
                    url : `http://localhost:8081/api/customer/getNameCustomer?phoneNumber=`+encodeURIComponent(phoneNumber),
                    success:function (data) {
                        if (data === ""){
                            valueCurrentPhoneNumber.text('')
                            customerName.text('');
                        }else {
                            customerName.text(data);
                        }
                    },
                    error:function (xhr,textStatus,errorThrow) {
                        console.log("Error",errorThrow)
                    }

                })
            });
        
        function reset(){
        	$('.newRow').remove();
        }

		function taoIDMoi() {
			return Math.random().toString(36).substr(2, 9); // Trả về một chuỗi ngẫu nhiên
		}


		/* $('#myTable').on('focusout','tr',function () {
			//buoc 1: lấy mảng ra
			let currentArray = JSON.parse(localStorage.getItem('myArray')) || [];
			let row = $(this);
			console.log(row)
			let id = row.attr('id');
			let rowData = {
				        id: id,
				        codeProduct: row.find('td:eq(2)').text(),
				        nameProduct: row.find('td:eq(3)').text(),
				        quantityBook: row.find('td:eq(5)').text(),
				        nameCustomer: row.find('td:eq(6)').text(),
				        phoneNumber: row.find('td:eq(7)').text()
				    };
			let existingIndex = currentArray.findIndex(item => item.id === id);
			console.log(existingIndex);
		    if (existingIndex !== -1) {
		        // Nếu đã tồn tại, cập nhật dữ liệu của dòng đó trong mảng
		        currentArray[existingIndex] = rowData;
		    } else {
		        // Nếu chưa tồn tại, thêm dữ liệu của dòng đó vào mảng
		        currentArray.push(rowData);
		    }
			localStorage.setItem('myArray', JSON.stringify(currentArray));
		}) */
</script>
<script>

        $(document).ready(function () {
        $("td.codeProduct[contenteditable=true]").focusout(function () {
            let codeProduct = $(this).text();
            let row = $(this).closest("tr");
            let nameProductCell = row.find("td:eq(3)");
            let valueCodeProduct = $(this);
	
            $.ajax({
                contentType :"application/json",
                method : "GET",
                url : `http://localhost:8081/api/product/getNameProduct?codeProduct=`+encodeURIComponent(codeProduct),
                success : function(data) {
                    if (data === "") {
                        nameProductCell.text('')
                       valueCodeProduct.text('')
                    }
                    else {
                        nameProductCell.text(data)
                    }
                    let currentArray = JSON.parse(localStorage.getItem('myArray')) || [];
                    let id = row.attr('id');
                    let rowData = {
                        id: id,
                        codeProduct: row.find('td:eq(2)').text(),
                        nameProduct: row.find('td:eq(3)').text(),
                        quantityBook: row.find('td:eq(5)').text(),
                        nameCustomer: row.find('td:eq(6)').text(),
                        phoneNumber: row.find('td:eq(7)').text()
                    };

                    let existingIndex = currentArray.findIndex(item => item.id === id);
                    if (existingIndex !== -1) {
                        currentArray[existingIndex] = rowData;
                    } else {
                        currentArray.push(rowData);
                    }

                    localStorage.setItem('myArray', JSON.stringify(currentArray));
                },
                error:function(xhr, textStatus, errorThrow){
                    console.log("Error",errorThrow)
                }
            })

        })
    });

    $(document).ready(function () {
        $("td.nameProduct[contenteditable=true]").focusout(function () {
            let nameProduct = $(this).text();
            let row = $(this).closest("tr");
            let codeProductCell = row.find("td:eq(2)");
            let valueNameProduct = $(this);

            $.ajax({
                contentType :"application/json",
                method : "GET",
                url : `http://localhost:8081/api/product/getCodeProduct?nameProduct=`+encodeURIComponent(nameProduct),
                success : function(data) {
                    if (data === "") {
                        codeProductCell.text('')
                        valueNameProduct.text('')
                    }
                    else {
                        codeProductCell.text(data)
                    }
                },
                error:function(xhr, textStatus, errorThrow){
                    console.log("Error",errorThrow)
                }
            })

        })
    });
    
    $(document).ready(function () {
    	$("td.customerName[contenteditable=true]").focusout(function () {
            let customerName = $(this).text();
            let row = $(this).closest("tr");
            let phoneNumberCell = row.find("td:eq(7)");
            let valueCurrentCustomerName = $(this);
            $.ajax({
                contentType :"application/json",
                method : "GET",
                url: `http://localhost:8081/api/customer/getPhoneNumber?customerName=`+encodeURIComponent(customerName),
                success:function (data) {
                    if (data === ""){
                        valueCurrentCustomerName.text('')
                        phoneNumberCell.text('');
                    }else {
                        phoneNumberCell.text(data);
                    }
                },
                error:function (xhr,textStatus,errorThrow) {
                    console.log("Error",errorThrow)
                }

            })
        })
    });

    $(document).ready(function () {
        $("td.phoneNumber[contenteditable=true]").focusout(function () {
            let phoneNumber = $(this).text();
            let row = $(this).closest("tr");
            let customerName = row.find("td:eq(6)");
            let valueCurrentPhoneNumber = $(this);
            $.ajax({
                contentType :"application/json",
                method : "GET",
                url : `http://localhost:8081/api/customer/getNameCustomer?phoneNumber=`+encodeURIComponent(phoneNumber),
                success:function (data) {
                    if (data === ""){s
                        valueCurrentPhoneNumber.text('')
                        customerName.text('');
                    }else {
                        customerName.text(data);
                    }
                },
                error:function (xhr,textStatus,errorThrow) {
                    console.log("Error",errorThrow)
                }

            })
        })
    });
</script>
</html>