<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Quản lý đơn hàng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
          <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        h1,td,th {
            text-align: center;
        }
        input{
            border-radius: 5px;
        }
        table{
            background-color: white;
        }
        body {
            background-color: #EAE9E5;
        }
        .createform {
            margin-bottom:5px;
        }
        .createform button {
            background-color:white;
            border-radius:5px;
        }
        #btn{
            margin-left: auto;
        }
        .hidden {
        	display:none;
        }
    </style>
</head>
<body>
    <div th:insert = "header :: nav"></div>
    <div class="container-fluid">
        <h1>Danh sách đơn hàng</h1>
        <div style="color: red;" th:if="${statusList}">
    		<div th:each="item : ${statusList}">
        	<span th:text="${item}"></span><br>
    		</div>
		</div>
        
        <div style="color: red" th:if="${message}">
        <span  th:text="${message}"></span>
        <script th:inline="javascript">           
            function myJavaScriptFunction() {
                var message = /*[[${message}]]*/ '';
                alert(message);
                
            }
                myJavaScriptFunction();

        </script>
    </div>
   
   <div class="form-search">
        <form th:action="@{/orders/list}" method="get" >
            <div th:if = "${roleName == 'ROLE_ADMIN'}">
            	<span>
                	Tên đăng nhập : <input class="input" type="text"  name="accountName" style="width:15%;margin-left: 11px" th:value="${accountName}" placeholder="Vui lòng nhập tên đăng nhập">
            	</span>
            </div>
            <div style="margin-top: 5px" th:if = "${roleName == 'ROLE_ADMIN'}">
            	<span>
                	Tên nhân viên : <input type="text" class="input"  name="employeeName" style="width:15%;margin-left: 18px" th:value="${employeeName}" placeholder="Vui lòng nhập tên nhân viên">
            	</span>
            </div>
             <div style="margin-top: 5px">
            	<span>
                	Mã sản phẩm  : <input type="text" class="input"  name="productCode" style="width:15%;margin-left: 19px" th:value="${productCode}" placeholder="Vui lòng nhập mã sản phẩm">
            	</span>
             </div>
            <div style="margin-top: 5px">
            	<span>
                	Tên sản phẩm  : <input type="text" class="input"  name="productName" style="width:15%;margin-left: 18px" th:value="${productName}" placeholder="Vui lòng nhập tên sản phẩm">
            	</span>
            </div>
            <div style="margin-top: 5px">
            	<span>
                	Tên khách hàng  : <input type="text" class="input"  name="customerName" style="width:15%;margin-left: 5px" th:value="${customerName}" placeholder="Vui lòng nhập tên khách hàng">
            	</span>
            </div>
            <div style="margin-top: 5px">
            	<span>
                	Số điện thoại : <input type="text" class="input" name="customerPhone" style="width:15%;margin-left: 13px" th:value="${customerPhone}" placeholder="Vui lòng nhập số điện thoại">
            	</span>
            </div>
             <div style="margin-top: 5px">
            	<span>
                	Ngày bắt đầu  : <input type="date" class="input"  name="orderDayBegin" style="width:8%;margin-left: 2px" th:value="${orderDayBegin}">
            	</span>
            </div>
            <div style="margin-top: 5px">
            	<span>
                	Ngày kết thúc  : <input type="date" class="input" name="orderDayEnd" style="width:8%;margin-left: 7px" th:value="${orderDayEnd}">
            	</span>
            </div>
           <div style="margin-top: 5px">
           			Trạng thái
            	<span style="margin-left: 3%">
                	 <input type="checkbox" name ="statusAllocation" th:checked = "${statusAllocation == 2 ? 'checked' : null}" value="2"  > Đã Phân bổ
            	</span>
            	<span style="padding-left: 3%">
                	 <input type="checkbox" name ="statusBooking" value="1" th:checked = "${statusBooking == 1 ? 'checked' : null}"> Đã đặt hàng
            	</span>
            </div>
            <div style="margin-top: 5px;">
                <input style="margin-bottom: 5px" type="submit" value="Search">
                <input style="margin-bottom: 5px" type="button" value="Clear" id="clear">
            </div>
        </form>
      </div> 
      
      
      <div>
      	<table id="myTable" class="table table-hover table-bordered">
      		<tr style="background-color: grey;color: white">
   	     			<th>STT</th>
   	     			<th>NGÀY ĐẶT HÀNG</th>
   	     			<th>Mã sản phẩm</th>
   	     			<th>TÊN SẢN PHẨM</th>
   	     			<th>GIÁ BÁN</th>
   	     			<th>SỐ LƯỢNG</th>
   	     			<th>TÊN KHÁCH HÀNG</th>
   	     			<th>SỐ ĐIỆN THOẠI</th>
   	     			<th>ĐỊA CHỈ</th>
   	     			<th>TRẠNG THÁI</th>
   	     			<th>NGÀY PHÂN BỔ</th>
   	     			<th th:if = "${roleName == 'ROLE_ADMIN'}">TÊN ĐĂNG NHẬP</th>
   	     			<th th:if = "${roleName == 'ROLE_ADMIN'}">TÊN NHÂN VIÊN </th>
   	     	</tr>
   	     	<tr th:if="${ordersMap.size() > 0}" th:each="order,status:${ordersMap}" th:id="${order['id']}">
                <td th:text="${status.count + page * limit}"></td>
                <td th:text="${#temporals.format(order['order_day'], 'yyyy/MM/dd HH:mm:ss')}"></td>
                <td class="productCode"  th:contenteditable="${(order['order_allocation'] == null)} ? 'true' : null" th:text="${order['productCode']}" ></td>
                <td class="productName"  th:contenteditable="${(order['order_allocation'] == null)} ? 'true' : null" th:text="${order['productName']}"></td>
                <td th:text="${#numbers.formatDecimal(order['price'], 0, 'COMMA', 0, 'POINT')} + ' VND'"></td>
                <td class="quantity" th:contenteditable="${(order['order_allocation'] == null)} ? 'true' : null" th:text="${order['quantity']}" ></td>
                <td class="customerName" th:contenteditable="${(order['order_allocation'] == null)} ? 'true' : null" th:text="${order['customerName']}"></td>
                <td class="customerPhone"  th:contenteditable="${(order['order_allocation'] == null)} ? 'true' : null" th:text="${order['customerPhone']}" ></td>
                <td th:text="${order['address']}"></td>
                <td th:text="${order['statusName']}"></td>
                <td th:text="${order['order_allocation'] != null ? #temporals.format(order['order_allocation'], 'yyyy/MM/dd HH:mm:ss') : 'Chưa phân bổ' }"></td>
                <td th:if = "${roleName == 'ROLE_ADMIN'}" th:text="${order['accountName']}"></td>
                <td th:if = "${roleName == 'ROLE_ADMIN'}" th:text="${order['employeeName']}"></td>
                <td class="hidden" th:text="${order['version']}" ></td>
   	     	</tr>
   	     	<tr th:each="order,status:${ordersMap}" th:id="${order['id']}" class="hidden">
                <td th:text="${status.count + page * limit}"></td>
                <td th:text="${#temporals.format(order['order_day'], 'yyyy/MM/dd HH:mm:ss')}"></td>
                <td class="productCode"  th:text="${order['productCode']}" ></td>
                <td class="productName"  th:text="${order['productName']}"></td>
                <td th:text="${#numbers.formatDecimal(order['price'], 0, 'COMMA', 0, 'POINT')} + ' VND'"></td>
                <td class="quantity" th:text="${order['quantity']}" ></td>
                <td class="customerName" th:text="${order['customerName']}"></td>
                <td class="customerPhone"  th:text="${order['customerPhone']}" ></td>
                <td th:text="${order['address']}"></td>
                <td th:text="${order['statusName']}"></td>
                <td th:text="${order['order_allocation'] != null ? #temporals.format(order['order_allocation'], 'yyyy/MM/dd HH:mm:ss') : 'Chưa phân bổ' }"></td>
                <td th:if = "${roleName == 'ROLE_ADMIN'}" th:text="${order['username']}"></td>
                <td th:if = "${roleName == 'ROLE_ADMIN'}" th:text="${order['employeeName']}"></td>
   	     	</tr>
            <tr th:if="${ordersMap.size() == 0}">
                <td colspan="13">Không tìm thấy đơn hàng</td>
            </tr>
      	</table>
      	<button id= "addRow" style="border-radius: 5px">Thêm dòng mới</button>
      	 <div th:if="${ordersMap.size() > 0}">
            <nav aria-label="Page navigation example" > 
	            <ul class="pagination" style="display: flex;justify-content: center">
	            	<li th:if="${page > 0}" class="page-item" >
	            		<a class="page-link" th:href="@{/orders/list(page=${page},accountName=${accountName},employeeName=${employeeName},productCode=${productCode},productName=${productName},customerName=${customerName},customerPhone=${customerPhone},orderDayBegin=${orderDayBegin},orderDayEnd=${orderDayEnd},statusAllocation=${statusAllocation},statusBooking=${statusBooking})}">Previous</a>
	            	</li>
	            	<li class="page-item"  th:if="${showStartEllipsis}">
	            		<span class="page-link">...</span >
	            	</li>
	            	<th:block th:each="pageNumber : ${#numbers.sequence(startPage, endPage)}">
	            		<li class="page-item active" th:if="${pageNumber -1 == page}">
	            			 <a class="page-link "  th:text="${pageNumber}"></a>	          
	            		</li>
	            		<li class="page-item" th:if="${pageNumber -1 != page}">
	            			<a class="page-link" th:text="${pageNumber}"  th:href="@{/orders/list(page=${pageNumber},accountName=${accountName},employeeName=${employeeName},productCode=${productCode},productName=${productName},customerName=${customerName},customerPhone=${customerPhone},orderDayBegin=${orderDayBegin},orderDayEnd=${orderDayEnd},statusAllocation=${statusAllocation},statusBooking=${statusBooking})}" ></a>
	            		</li>
	            	</th:block>
	            	<li class="page-item"  th:if="${showEndEllipsis}">
	            		<span  class="page-link">...</span>
	            	</li>
	            	<li class="page-item" th:if="${page + 1 != totalPage }">
	            		<a class="page-link" th:href="@{/orders/list(page=${page + 2},accountName=${accountName},employeeName=${employeeName},productCode=${productCode},productName=${productName},customerName=${customerName},customerPhone=${customerPhone},orderDayBegin=${orderDayBegin},orderDayEnd=${orderDayEnd},statusAllocation=${statusAllocation},statusBooking=${statusBooking})}">Next</a>
	            	</li>
	            </ul>
            </nav> 
        </div>
        
        <div style="float:right">
        	<button style="border-radius: 5px" id="add"  >
        		Lưu
        	</button>
        	<button style="border-radius: 5px" id= "reset" >Reset</button>
        </div>
      </div>
    </div>
</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous">
</script>
<script>
	$(document).ready(function () {
		let data = JSON.parse(localStorage.getItem('myArray')) || [];
		render(data);
		let temp = JSON.parse(localStorage.getItem('cellErrors')) || [];
		if (temp.length !== 0) {
			handleCellErrors(temp);
		}

	});

	function taoIDMoi() {
		return Math.random().toString(36).substr(2, 9); // Trả về một chuỗi ngẫu nhiên
	}
	
	function compareObjectValue (oldObject, newObject){
		return oldObject.id === newObject.id && oldObject.productCode === newObject.productCode
				&& oldObject.productName === newObject.productName && oldObject.quantity === newObject.quantity
				&& oldObject.customerPhone === newObject.customerPhone && oldObject.customerName === newObject.customerName;
	}

	function checkChangeValue(id, rowData){
		let currentArray = JSON.parse(localStorage.getItem('myArray')) || [];
		let recordHidden = $('#myTable').find('tr.hidden[id="' + id + '"]');
		let oldValue = {
			id : id,
			productCode: recordHidden.find('.productCode').text(),
			productName: recordHidden.find('.productName').text(),
			quantity: recordHidden.find('.quantity').text(),
			customerName: recordHidden.find('.customerName').text(),
			customerPhone: recordHidden.find('.customerPhone').text()
		};
		if (!compareObjectValue(oldValue,rowData)){
			let existingIndex = currentArray.findIndex(item => item.id === id);
			if (existingIndex !== -1) {
				currentArray[existingIndex] = rowData;
			}else {
				currentArray.push(rowData);
			}
		}else {
			let existingIndex = currentArray.findIndex(item => item.id === id);
			if (existingIndex !== -1){
				currentArray.splice(existingIndex,1)
			}
			
		}
		
		if (currentArray.length === 0){
			localStorage.removeItem('myArray');
			localStorage.removeItem('cellErrors');
		}else{
			localStorage.setItem('myArray', JSON.stringify(currentArray));
		}
	
		
	}
	
	$(document).ready(function () {
	
		$('#clear').on('click',function () {
			$('.input').val(null);
		});
	 
	 	$('#reset').on('click',function () {
		 	localStorage.clear();
		 	location.reload();
	 	});
	
	
     	$('#addRow').on('click',function () {
        	let newRowID = taoIDMoi();
        	$('#myTable').append('<tr id='+newRowID + ' >' +
                '                     <td></td>\n' +
                '                     <td></td>\n' +
                '                     <td class="productCode"   contenteditable="true" ></td>\n' +
                '                     <td class="productName"   contenteditable="true"></td>\n' +
                '                     <td></td>\n' +
                '                     <td class="quantity"      contenteditable="true"></td>\n' +
                '                     <td class="customerName"  contenteditable="true"></td>\n' +
                '                     <td class="customerPhone" contenteditable="true"></td>\n' +
                '                     <td ></td>\n' +
                '                     <td></td>\n' +
                '                     <td></td>\n' +
              /*   '                     <td th:if = "${roleName == \'ROLE_ADMIN\'}"></td>\n' +
                '                     <td th:if = "${roleName == \'ROLE_ADMIN\'}"></td>' + */
                '                </tr>')

        });
        
        $('#add').on('click',function (){
        	$('#myTable td').css('background-color','white')
        	let temp = localStorage.getItem('myArray') || [];
        	if(temp.length === 0){
        		alert ("Không có dữ liệu thay đổi");
        	}else {
        		$.ajax({
					type: "POST",
					contentType: "application/json",
					url: "/api/orders/save",
					data: temp,
					success : function(response){
						if (JSON.stringify(response) === "{}"){
							alert("Cập nhật dữ liệu thành công");
							localStorage.clear();
							location.reload();
						}else {
							localStorage.setItem('cellErrors',JSON.stringify(response))
							for (let key in response){
								if (response.hasOwnProperty(key)){
									let valueList = response[key];
									console.log(key);
									console.log(valueList);
									valueList.forEach(function (value) {
										let table = $('#myTable');
										table.find('tr[id="' + key + '"]').find('td.'+value).css('background-color','red');
										})
									}
								}
							alert("Dữ liệu không hợp lệ, vui lòng kiểm tra dữ liệu ở những ô màu đỏ.")
							}
						},
					error:function(xhr, status, error) {
						console.error("lỗi khi gửi dữ liệu :" + error);
						alert ("Dữ liệu chưa được cập nhật. Vui lòng nhập lại")
						localStorage.clear();
						location.reload();
					}
				})
        	}
        	
        });

        $('#myTable').on('focusout','td.productCode[contenteditable="true"]',function () {
        	   let productCode = $(this).text();
               let row = $(this).closest("tr");
               let productNameCell = row.find("td:eq(3)");
               let valueProductCode = $(this);
               $.ajax({
                   contentType :"application/json",
                   method : "GET",
                   url : `http://localhost:8081/api/product/getProductName?productCode=`+encodeURIComponent(productCode),
                   success : function(data) {
                       if (data === "") {
                    	   productNameCell.text('')
                           valueProductCode.text('')
                       }
                       else {
                    	   productNameCell.text(data)
                       }
                       let id = row.attr('id');
                       let rowData = {
                           id: id,
                           productCode: row.find('td:eq(2)').text(),
                           productName: row.find('td:eq(3)').text(),
                           quantity: row.find('td:eq(5)').text(),
                           customerName: row.find('td:eq(6)').text(),
                           customerPhone: row.find('td:eq(7)').text(),
                           version : row.find('td:eq(13)').text()
                       };
                       console.log(rowData);
						checkChangeValue(id,rowData);
                   },
                   error:function(xhr, textStatus, errorThrow){
                       console.log("Error",errorThrow)
                   }
               })
        });
         
        $('#myTable').on('focusout','td.productName[contenteditable="true"]',function () {
        	  let productName = $(this).text();
              let row = $(this).closest("tr");
              let productCodeCell = row.find("td:eq(2)");
              let valueProductName = $(this);
              $.ajax({
                  contentType :"application/json",
                  method : "GET",
                  url : `http://localhost:8081/api/product/getProductCode?productName=`+encodeURIComponent(productName),
                  success : function(data) {
                      if (data === "") {
                    	  productCodeCell.text('')
                          valueProductName.text('')
                      }
                      else {
                    	  productCodeCell.text(data)
                      }
                      let id = row.attr('id');
                      let rowData = {
                              id: id,
                              productCode: row.find('td:eq(2)').text(),
                              productName: row.find('td:eq(3)').text(),
                              quantity: row.find('td:eq(5)').text(),
                              customerName: row.find('td:eq(6)').text(),
                              customerPhone: row.find('td:eq(7)').text(),
                              version : row.find('td:eq(13)').text()
                      };
					  checkChangeValue(id,rowData);
                  },
                  error:function(xhr, textStatus, errorThrow){
                      console.log("Error",errorThrow)
                  }
              })
        });
        
         $('#myTable').on('focusout','td.customerName[contenteditable="true"]',function () {
             let customerName = $(this).text();
             let row = $(this).closest("tr");
             let customerPhoneCell = row.find("td:eq(7)");
             let valueCurrentCustomerName = $(this);
             $.ajax({
                 contentType :"application/json",
                 method : "GET",
                 url: `http://localhost:8081/api/customer/getCustomerPhone?customerName=`+encodeURIComponent(customerName),
                 success:function (data) {
                	
                	 if (data === ""){
                         valueCurrentCustomerName.text('')
                         customerPhoneCell.text('');
                     }else {
                    	 customerPhoneCell.text(data);
                     }
                     let id = row.attr('id');
                     let rowData = {
                             id: id,
                             productCode: row.find('td:eq(2)').text(),
                             productName: row.find('td:eq(3)').text(),
                             quantity: row.find('td:eq(5)').text(),
                             customerName: row.find('td:eq(6)').text(),
                             customerPhone: row.find('td:eq(7)').text(),
                             version : row.find('td:eq(13)').text()
                     };
                     console.log(rowData);
					 checkChangeValue(id,rowData)
                 },
                 error:function (xhr,textStatus,errorThrow) {
                     console.log("Error",errorThrow)
                 }

             })
        });
        
        $('#myTable').on('focusout','td.customerPhone[contenteditable="true"]',function () {
                // Thực hiện yêu cầu Ajax khi ô phoneNumber mất focus
                let customerPhone = $(this).text();
                let row = $(this).closest("tr");
                let customerName = row.find("td:eq(6)");
                let valueCurrentCustomerPhone = $(this);
                $.ajax({
                    contentType :"application/json",
                    method : "GET",
                    url : `http://localhost:8081/api/customer/getCustomerName?customerPhone=`+encodeURIComponent(customerPhone),
                    success:function (data) {
                        if (data === ""){
                        	valueCurrentCustomerPhone.text('')
                            customerName.text('');
                        }else {
							customerName.text(data);
						}
                        let id = row.attr('id');
                        let rowData = {
                                id: id,
                                productCode: row.find('td:eq(2)').text(),
                                productName: row.find('td:eq(3)').text(),
                                quantity: row.find('td:eq(5)').text(),
                                customerName: row.find('td:eq(6)').text(),
                                customerPhone: row.find('td:eq(7)').text(),
                                version : row.find('td:eq(13)').text()
                        };
						checkChangeValue(id,rowData);
                    },
                    error:function (xhr,textStatus,errorThrow) {
                        console.log("Error",errorThrow)
                    }

                })
            });
        
        $('#myTable').on('focusout','td.quantity[contenteditable="true"]',function () {
			let row = $(this).closest("tr");
			console.log(row)
			let id = row.attr('id');
			 let rowData = {
                     id: id,
                     productCode: row.find('td:eq(2)').text(),
                     productName: row.find('td:eq(3)').text(),
                     quantity: row.find('td:eq(5)').text(),
                     customerName: row.find('td:eq(6)').text(),
                     customerPhone: row.find('td:eq(7)').text(),
                     version : row.find('td:eq(13)').text()
             };
			checkChangeValue(id,rowData);
		})  
       window.addEventListener('storage',function (event) {
		   if(event.key === "myArray"){
			   localStorage.removeItem('myArray');
			   location.reload();
			   console.log("Đã chỉnh sửa local storage ")
		   }
	   })
	});
      
		function render(data) {
			let tbody = $('#myTable');
			data.forEach(function (row) {
				if (isNaN(Number(`${row.id}`))) {
					console.log(isNaN(Number(`${row.id}`)));
					tbody.append(`<tr id=${row.id}>
									<td></td>
									<td></td>
									<td class="productCode" contenteditable="true">${row.productCode}</td>
									<td class="productName" contenteditable="true">${row.productName}</td>
									<td></td>
									<td class="quantity" contenteditable="true">${row.quantity}</td>
									<td class="customerName" contenteditable="true">${row.customerName}</td>
									<td class="customerPhone"  contenteditable="true">${row.customerPhone}</td>
									<td></td>
									<td></td>
									<td></td>
									<td></td>
									<td></td>
								  </tr>`)
				} else {
					let id = `${row.id}`;
					tbody.find('tr[id="' + id + '"]').find('.productCode').text(`${row.productCode}`);
					tbody.find('tr[id="' + id + '"]').find('.productName').text(`${row.productName}`);
					tbody.find('tr[id="' + id + '"]').find('.quantity').text(`${row.quantity}`);
					tbody.find('tr[id="' + id + '"]').find('.customerName').text(`${row.customerName}`);
					tbody.find('tr[id="' + id + '"]').find('.customerPhone').text(`${row.customerPhone}`);
				}
			})
		}

		function handleCellErrors(response) {
			for (let key in response){
				if (response.hasOwnProperty(key)){
					let  valueList = response[key];
					console.log(key);
					console.log(valueList);
					valueList.forEach(function (value) {
						let table = $('#myTable');
						table.find('tr[id="' + key + '"]').find('td.'+value).css('background-color','red');
					})
				}
			}
		}
</script>
</html>